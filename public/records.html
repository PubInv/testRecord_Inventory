<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Krake – Inventory & History</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="top-nav">
    <a href="factory-form.html" class="nav-btn">Krake Testing Register</a>
    <a href="records.html" class="nav-btn active">Inventory &amp; History</a>
    <a href="board.html" class="nav-btn">Test History</a>
    <a href="labels.html" class="nav-btn">QR Label from Image</a>
  </nav>

  <div class="records-container">
    <header class="records-header">
      <h1>Krake Inventory &amp; Test History</h1>
      <div class="records-controls">
        <label>
          Filter by Serial:
          <input type="text" id="filterSerial" placeholder="e.g. KRK-LB-001">
        </label>
        <label>
          Filter by Country:
          <input type="text" id="filterCountry" placeholder="e.g. Lebanon">
        </label>
        <button id="reloadBtn" class="btn-primary">Reload</button>
        <button id="exportCsvBtn" class="btn-secondary">Export to Excel (CSV)</button>
      </div>
    </header>

    <table class="records-table">
      <thead>
        <tr>
          <th>Serial</th>
          <th>Status</th>
          <th>Country</th>
          <th>Lab</th>
          <th>HW Rev</th>
          <th>Test Datetime</th>
          <th>Location</th>
          <th>Tester</th>
          <th>Firmware</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody id="recordsBody">
        <!-- Filled by JS -->
      </tbody>
    </table>

    <p id="recordCount" class="record-count">0 boards</p>
  </div>

<script>
  const API_BASE = ''; // same origin

  const recordsBody = document.getElementById('recordsBody');
  const recordCount = document.getElementById('recordCount');
  const filterSerial = document.getElementById('filterSerial');
  const filterCountry = document.getElementById('filterCountry');
  const reloadBtn = document.getElementById('reloadBtn');

  async function loadTestRuns() {
    recordsBody.innerHTML = '<tr><td colspan="10">Loading...</td></tr>';
    try {
      const resp = await fetch(`${API_BASE}/api/test-runs`);
      if (!resp.ok) {
        throw new Error(`Server error: ${resp.status}`);
      }
      const data = await resp.json();
      renderTable(data);
    } catch (err) {
      console.error(err);
      recordsBody.innerHTML = `<tr><td colspan="10">Error: ${err.message}</td></tr>`;
      recordCount.textContent = '0 boards';
    }
  }

  function renderTable(rows) {
    const sFilter = filterSerial.value.trim().toLowerCase();
    const cFilter = filterCountry.value.trim().toLowerCase();

    // Filter by serial + country
    const filtered = rows.filter(r => {
      const matchesSerial = sFilter
        ? (r.serial_number || '').toLowerCase().includes(sFilter)
        : true;
      const matchesCountry = cFilter
        ? (r.country || '').toLowerCase().includes(cFilter)
        : true;
      return matchesSerial && matchesCountry;
    });

    if (!filtered.length) {
      recordsBody.innerHTML = '<tr><td colspan="10">No records found</td></tr>';
      recordCount.textContent = '0 boards';
      return;
    }

    recordsBody.innerHTML = '';
    for (const row of filtered) {
      const tr = document.createElement('tr');

      // Serial → link to board page
      const serialCell = document.createElement('td');
      const link = document.createElement('a');
      link.href = `board.html?serial=${encodeURIComponent(row.serial_number)}`;
      link.textContent = row.serial_number || '(unknown)';
      serialCell.appendChild(link);
      tr.appendChild(serialCell);

      // Status
      const statusCell = document.createElement('td');
      statusCell.textContent = row.status || '';
      tr.appendChild(statusCell);

      // Country
      const countryCell = document.createElement('td');
      countryCell.textContent = row.country || '';
      tr.appendChild(countryCell);

      // Lab
      const labCell = document.createElement('td');
      labCell.textContent = row.lab || '';
      tr.appendChild(labCell);

      // HW Rev
      const hwCell = document.createElement('td');
      hwCell.textContent = row.hardware_rev || '';
      tr.appendChild(hwCell);

      // Test datetime (latest run)
      const dtCell = document.createElement('td');
      dtCell.textContent = row.test_datetime
        ? new Date(row.test_datetime).toLocaleString()
        : '';
      tr.appendChild(dtCell);

      // Location
      const locCell = document.createElement('td');
      locCell.textContent = row.test_location || '';
      tr.appendChild(locCell);

      // Tester
      const testerCell = document.createElement('td');
      testerCell.textContent = row.tester || '';
      tr.appendChild(testerCell);

      // Firmware
      const fwCell = document.createElement('td');
      fwCell.textContent = row.firmware_version || '';
      tr.appendChild(fwCell);

      // Result
      const resultCell = document.createElement('td');
      const res = row.overall_result || '';
      resultCell.textContent = res;
      resultCell.className =
        res === 'PASS' ? 'result-pass'
        : res === 'FAIL' ? 'result-fail'
        : 'result-other';
      tr.appendChild(resultCell);

      recordsBody.appendChild(tr);
    }

    recordCount.textContent = `${filtered.length} board(s)`;
  }

  reloadBtn.addEventListener('click', loadTestRuns);
  filterSerial.addEventListener('input', loadTestRuns);
  filterCountry.addEventListener('input', loadTestRuns);

  document.getElementById('exportCsvBtn').addEventListener('click', () => {
    window.location.href = `${API_BASE}/api/test-runs.csv`;
  });

  loadTestRuns();
</script>
</body>
</html>
